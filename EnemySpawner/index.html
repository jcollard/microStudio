<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enemy Spawner - Dynamic Enemy System</title>

    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- jsdiff for computing code differences -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>

    <!-- Our custom code rendering functions -->
    <script src="codeblocks.js"></script>

    <!-- Lazy embed functionality -->
    <script src="lazy-embed.js"></script>

    <!-- Sprite gallery functionality -->
    <script src="sprite-gallery.js"></script>

    <!-- Main page styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- Code block and diff styles -->
    <link rel="stylesheet" href="codeblocks.css">

    <!-- Sprite gallery styles -->
    <link rel="stylesheet" href="sprite-gallery.css">
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <h1>Enemy Spawner</h1>
            <p class="subtitle">Dynamic Enemy System with Wave Mechanics</p>
        </header>

        <!-- Navigation -->
        <nav class="step-nav">
            <div class="nav-container">
                <button class="nav-btn prev-btn" id="prevBtn" onclick="navigateStep(-1)">
                    ‚Üê Previous
                </button>

                <div class="step-selector">
                    <label for="stepSelect">Step:</label>
                    <select id="stepSelect" onchange="loadSelectedStep()">
                        <option value="0">0: Welcome</option>
                        <option value="1">1: Getting Started</option>
                        <option value="2">2: Create spawn_enemy()</option>
                        <option value="3">2b: CHALLENGE - Randomize</option>
                        <option value="4">3: Replace init_enemies()</option>
                        <option value="5">4: Object Pooling</option>
                        <option value="6">5: all_enemies_destroyed()</option>
                        <option value="7">6: Auto-spawn</option>
                        <option value="8">7: spawn_enemy_wave()</option>
                        <option value="9">8: Wave System</option>
                        <option value="10">9: Congratulations</option>
                    </select>
                </div>

                <button class="nav-btn" onclick="showGallery()" title="Browse available sprites">
                    üé® Sprite Gallery
                </button>

                <button class="nav-btn next-btn" id="nextBtn" onclick="navigateStep(1)">
                    Next ‚Üí
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div id="step-content" class="step-container">
                <!-- Step content will be loaded here dynamically -->
                <div class="loading">Loading step content...</div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="page-footer">
            <p>Part of the microStudio Game Development Curriculum</p>
        </footer>
    </div>

    <!-- Step Loading JavaScript -->
    <script>
        // Array-based step tracking (handles non-sequential names like "step2b")
        const steps = ['step0', 'step1', 'step2', 'step2b', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9'];
        let currentStepIndex = 0;

        /**
         * Load a specific step by index
         */
        async function loadStep(stepIndex) {
            // Validate step index
            if (stepIndex < 0 || stepIndex >= steps.length) {
                console.error(`Invalid step index: ${stepIndex}`);
                return;
            }

            currentStepIndex = stepIndex;
            const stepName = steps[stepIndex];

            // Save to localStorage
            localStorage.setItem('enemySpawner_currentStep', stepIndex);

            // Update UI
            updateNavigation();

            // Show loading message
            const contentArea = document.getElementById('step-content');
            contentArea.innerHTML = '<div class="loading">Loading step content...</div>';

            try {
                // Fetch step HTML using step name
                const response = await fetch(`steps/${stepName}.html`);

                if (!response.ok) {
                    throw new Error(`Failed to load ${stepName}: ${response.statusText}`);
                }

                const html = await response.text();

                // Parse HTML using DOMParser for proper parsing
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Extract scripts before setting content
                const scripts = Array.from(doc.querySelectorAll('script'));
                const scriptTexts = scripts.map(script => script.textContent);

                // Remove scripts from parsed document
                scripts.forEach(script => script.remove());

                // Clear content area and insert HTML without scripts
                contentArea.innerHTML = '';

                // Move all body content to contentArea
                while (doc.body.firstChild) {
                    contentArea.appendChild(doc.body.firstChild);
                }

                // Execute scripts directly using eval in order
                scriptTexts.forEach((scriptText, index) => {
                    try {
                        // Use indirect eval to execute in global scope
                        (0, eval)(scriptText);
                    } catch (error) {
                        console.error(`Error executing script ${index + 1}:`, error);
                    }
                });

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading step:', error);
                contentArea.innerHTML = `
                    <div class="error-box">
                        <h2>Error Loading Step</h2>
                        <p>Could not load ${stepName}. Please make sure the step file exists.</p>
                        <p class="error-detail">${error.message}</p>
                    </div>
                `;
            }
        }

        /**
         * Navigate to next/previous step
         */
        function navigateStep(direction) {
            const newStepIndex = currentStepIndex + direction;
            if (newStepIndex >= 0 && newStepIndex < steps.length) {
                loadStep(newStepIndex);
            }
        }

        /**
         * Load step from dropdown selection
         */
        function loadSelectedStep() {
            const select = document.getElementById('stepSelect');
            const stepIndex = parseInt(select.value);
            loadStep(stepIndex);
        }

        /**
         * Update navigation UI (button states, dropdown selection)
         */
        function updateNavigation() {
            // Update dropdown
            const select = document.getElementById('stepSelect');
            select.value = currentStepIndex;

            // Update button states
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentStepIndex === 0;
            nextBtn.disabled = currentStepIndex === (steps.length - 1);
        }

        /**
         * Initialize page - load last visited step or Step 0
         */
        window.addEventListener('DOMContentLoaded', () => {
            // Check localStorage for saved step
            const savedStepIndex = localStorage.getItem('enemySpawner_currentStep');
            const initialStepIndex = savedStepIndex !== null ? parseInt(savedStepIndex) : 0;

            // Validate saved step is within valid range
            if (initialStepIndex >= 0 && initialStepIndex < steps.length) {
                loadStep(initialStepIndex);
            } else {
                loadStep(0);
            }
        });
    </script>
</body>
</html>
