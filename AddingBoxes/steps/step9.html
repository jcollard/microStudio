<h2>Step 9: Refactor - Using Width and Height Instead of Size</h2>
<div class="step-content">
    <p>Excellent work! All our game objects now have bounding boxes. But there's a limitation: our boxes are always square because we use a single <code>size</code> property. Let's refactor to use separate <code>width</code> and <code>height</code> properties for more flexibility!</p>

    <div class="diagram">
        <h3 style="margin-bottom: 15px;">What Your Final Result Should Look Like:</h3>
        <iframe src="https://microstudio.io/jocolloman/addboxstep52222/P4P69D2U/"
                width="100%"
                height="500"
                style="border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 10px; background: #000;">
        </iframe>
        <p style="margin-top: 10px; color: #a0a0a0; font-size: 0.9em;">
            Notice the laser bounding boxes are now narrower (2x8 instead of 8x8)!<br>
            This is a <strong>refactoring</strong> - we're improving code structure and accuracy without changing core behavior.
        </p>
    </div>

    <div class="info-box">
        <h3>üí° What is Refactoring?</h3>
        <p><strong>Refactoring</strong> means restructuring existing code to improve its design without changing its external behavior. In this step, we're making our bounding box system more flexible by supporting rectangular (not just square) boxes.</p>
        <p><strong>Why separate width and height?</strong></p>
        <ul>
            <li>Some game objects are wider than they are tall (or vice versa)</li>
            <li>The laser sprite is tall and narrow - a rectangular box (2x8) matches it better than a square!</li>
            <li>More accurate collision detection for non-square sprites</li>
            <li>Industry standard - most game engines use width/height, not size</li>
            <li>Prepares us for future enhancements</li>
        </ul>
    </div>

    <div class="warning-box">
        <h3>‚ö†Ô∏è What We're Changing</h3>
        <p>We need to update every place that uses <code>size</code>:</p>
        <ul>
            <li><code>create_box()</code> function - change the parameter and property</li>
            <li><code>draw_box()</code> function - update to use width and height</li>
            <li><code>init_eyes()</code> - update both eye creation calls</li>
            <li><code>init_player()</code> - update player creation call</li>
            <li><code>create_laser()</code> - update laser creation call</li>
            <li><code>draw_eyes()</code>, <code>draw_player()</code>, <code>draw_lasers()</code> - No changes needed! (They use draw_box)</li>
        </ul>
    </div>

    <h3>Step 1: Refactor the <code>create_box()</code> Function</h3>
    <p>First, let's update the function signature and the box object it creates.</p>

    <div class="comparison">
        <div class="comparison-item">
            <h4>Before (using size)</h4>
            <div class="code-block no-copy">
                <pre>function create_box(x, y, size, vx, vy, color)
  local new_box = {
    x = x,
    y = y,
    size = size,
    vx = vx,
    vy = vy,
    color = color,
    original_color = color
  }
  return new_box
end</pre>
            </div>
        </div>
        <div class="comparison-item">
            <h4>After (using width and height)</h4>
            <div class="code-block no-copy">
                <pre>function create_box(x, y, width, height, vx, vy, color)
  local new_box = {
    x = x,
    y = y,
    width = width,
    height = height,
    vx = vx,
    vy = vy,
    color = color,
    original_color = color
  }
  return new_box
end</pre>
            </div>
        </div>
    </div>

    <div class="info-box">
        <h3>üìù What Changed?</h3>
        <ul>
            <li>Parameter changed from <code>size</code> to <code>width, height</code></li>
            <li>Box object now has <code>width</code> and <code>height</code> properties instead of <code>size</code></li>
            <li>Everything else stays the same!</li>
        </ul>
    </div>

    <h3>Step 2: Refactor the <code>draw_box()</code> Function</h3>
    <p>Now update the draw_box function to use width and height instead of size.</p>

    <div class="comparison">
        <div class="comparison-item">
            <h4>Before (using size)</h4>
            <div class="code-block no-copy">
                <pre>function draw_box(b)
  screen:setColor(b.color)
  screen:fillRect(b.x, b.y, b.size, b.size)
end</pre>
            </div>
        </div>
        <div class="comparison-item">
            <h4>After (using width and height)</h4>
            <div class="code-block no-copy">
                <pre>function draw_box(b)
  screen:setColor(b.color)
  screen:fillRect(b.x, b.y, b.width, b.height)
end</pre>
            </div>
        </div>
    </div>

    <div class="info-box">
        <h3>üìù What Changed?</h3>
        <ul>
            <li>Changed <code>b.size, b.size</code> to <code>b.width, b.height</code></li>
            <li>Now rectangles can have different widths and heights!</li>
        </ul>
    </div>

    <h3>Step 3: Update <code>init_eyes()</code></h3>
    <p>Now update the eye creation to pass width and height separately. We'll use 28x28 for the eyes.</p>

    <div class="comparison">
        <div class="comparison-item">
            <h4>Before (using size)</h4>
            <div class="code-block no-copy">
                <pre>function init_eyes()
  eye_rotation = 0

  left_eye = create_box(0, 0, 32, 0.7, 0.57575, "#FF00FF")

  right_eye = create_box(0, 0, 32, -0.6, 0.37575, "#00FFFF")
end</pre>
            </div>
        </div>
        <div class="comparison-item">
            <h4>After (using width and height)</h4>
            <div class="code-block no-copy">
                <pre>function init_eyes()
  eye_rotation = 0

  left_eye = create_box(0, 0, 28, 28, 0.7, 0.57575, "#FF00FF")

  right_eye = create_box(0, 0, 28, 28, -0.6, 0.37575, "#00FFFF")
end</pre>
            </div>
        </div>
    </div>

    <h3>Step 4: Update <code>init_player()</code></h3>
    <p>Update the player creation. The player is also square (25x25).</p>

    <div class="comparison">
        <div class="comparison-item">
            <h4>Before (using size)</h4>
            <div class="code-block no-copy">
                <pre>function init_player()
  player = create_box(0, -80, 25, 0, 0, "#00FF00")

  rotation = 0
end</pre>
            </div>
        </div>
        <div class="comparison-item">
            <h4>After (using width and height)</h4>
            <div class="code-block no-copy">
                <pre>function init_player()
  player = create_box(0, -80, 25, 25, 0, 0, "#00FF00")

  rotation = 0
end</pre>
            </div>
        </div>
    </div>

    <h3>Step 5: Update <code>create_laser()</code></h3>
    <p>Update laser creation. Lasers are rectangular (2 wide by 8 tall) to better match the laser sprite!</p>

    <div class="comparison">
        <div class="comparison-item">
            <h4>Before (using size)</h4>
            <div class="code-block no-copy">
                <pre>function create_laser()
  return create_box(0, 200, 8, 0, 2, "#FF0000")
end</pre>
            </div>
        </div>
        <div class="comparison-item">
            <h4>After (using width and height)</h4>
            <div class="code-block no-copy">
                <pre>function create_laser()
  return create_box(0, 200, 2, 8, 0, 2, "#FF0000")
end</pre>
            </div>
        </div>
    </div>

    <div class="success-box">
        <h3>‚ú® Great News: No Draw Function Changes Needed!</h3>
        <p>Since we use the <code>draw_box()</code> helper function in <code>draw_eyes()</code>, <code>draw_player()</code>, and <code>draw_lasers()</code>, those functions don't need any changes!</p>
        <p>The <code>draw_box()</code> function we updated in Step 2 already handles width and height correctly, so all the drawing code automatically works with the new properties.</p>
        <p><strong>This is the power of helper functions!</strong> We only had to change one function (<code>draw_box</code>) instead of updating three different draw functions.</p>
    </div>

    <div class="success-box">
        <h3>‚úÖ Testing Your Refactoring</h3>
        <p>After making your changes, run your game and verify:</p>
        <ul>
            <li>‚úÖ No error messages appear</li>
            <li>‚úÖ The laser bounding boxes are now narrower (2 pixels wide, 8 tall)</li>
            <li>‚úÖ The eye bounding boxes are slightly smaller (28x28 instead of 32x32)</li>
            <li>‚úÖ The player box stays the same (25x25)</li>
            <li>‚úÖ Eyes bounce around correctly</li>
            <li>‚úÖ Player moves correctly</li>
            <li>‚úÖ Lasers fire and move correctly</li>
            <li>‚úÖ All sprites render properly</li>
        </ul>
        <p><strong>Remember:</strong> Good refactoring improves code structure and accuracy!</p>
    </div>

    <div class="info-box">
        <h3>üìã Summary of Changes</h3>
        <p>Here's a quick checklist of all the functions you updated:</p>
        <ul>
            <li>‚úÖ <code>create_box()</code> - Changed signature and properties</li>
            <li>‚úÖ <code>draw_box()</code> - Changed to use width and height</li>
            <li>‚úÖ <code>init_eyes()</code> - Updated 2 create_box calls</li>
            <li>‚úÖ <code>init_player()</code> - Updated 1 create_box call</li>
            <li>‚úÖ <code>create_laser()</code> - Updated 1 create_box call</li>
            <li>‚úÖ <code>draw_eyes()</code>, <code>draw_player()</code>, <code>draw_lasers()</code> - No changes needed! (They use draw_box)</li>
        </ul>
        <p><strong>Total changes:</strong> 5 functions modified, 3 functions work automatically!</p>
    </div>

    <div class="warning-box">
        <h3>üí° Pro Tips</h3>
        <ul>
            <li><strong>Tip 1:</strong> When refactoring, make one change at a time and test frequently!</li>
            <li><strong>Tip 2:</strong> Use Find & Replace carefully - search for <code>.size</code> to find all uses</li>
            <li><strong>Tip 3:</strong> Notice the lasers are now rectangular (2x8) - this better matches their tall, narrow sprite!</li>
            <li><strong>Tip 4:</strong> This refactoring prepares us for collision detection in the next lesson</li>
        </ul>
    </div>

    <div class="info-box">
        <h3>üéì What You Learned</h3>
        <ul>
            <li>How to refactor existing code systematically</li>
            <li>The importance of width/height over a single size property</li>
            <li>How to update function signatures and all their call sites</li>
            <li>The power of helper functions - change one function, benefit everywhere!</li>
            <li>How to use rectangular bounding boxes for more accurate collision detection</li>
            <li>Industry best practices for bounding boxes</li>
        </ul>
    </div>

    <p><strong>Congratulations! You've successfully refactored your bounding box system. Your code is now more flexible and ready for collision detection. Click "Next" to finish!</strong></p>
</div>
